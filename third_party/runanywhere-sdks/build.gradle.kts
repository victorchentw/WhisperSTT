// Root build script for RunAnywhere Android SDK
//
// SIMPLIFIED BUILD TASKS:
// ----------------------
// The SDK is now a local module that builds automatically with the apps.
// No need to build or publish the SDK separately during development!
//
// AVAILABLE TASKS:
//   1. buildAll            - Build SDK and all example apps (creates local.properties everywhere)
//   2. buildAndroidApp     - Build Android sample app (SDK builds automatically)
//   3. runAndroidApp       - Build and launch Android app on connected device
//   4. buildIntellijPlugin - Build IntelliJ plugin (publishes SDK to Maven Local first)
//   5. runIntellijPlugin   - Build and launch IntelliJ plugin in sandbox
//   6. cleanAll            - Clean all projects
//
// PUBLISHING (for SDK distribution only):
//   publishSdkToMavenLocal - Publish SDK to Maven Local repository
//
// Run these tasks from IntelliJ run configurations or via:
//   ./gradlew <taskName>

plugins {
    // Apply plugins to submodules only - no root plugins needed for composite builds
    id("io.gitlab.arturbosch.detekt") version "1.23.8" apply false
}

// Configure all projects
allprojects {
    group = "com.runanywhere"
    version = "0.1.0"
}

// Configure subprojects (not composite builds)
subprojects {
    tasks.withType<Test> {
        useJUnitPlatform()
        testLogging {
            events("passed", "skipped", "failed")
        }
    }
}

// ============================================================================
// UNIFIED BUILD TASK - Builds everything with proper local.properties setup
// ============================================================================

tasks.register("buildAll") {
    group = "build"
    description = "Build SDK and all example apps (ensures local.properties exists everywhere)"

    doFirst {
        println("=".repeat(70))
        println(" Building RunAnywhere SDK and Examples")
        println("=".repeat(70))
        println()

        // Ensure local.properties exists in all necessary locations
        val locations = listOf(
            projectDir,  // Root
            file("sdk/runanywhere-kotlin"),  // SDK
            file("examples/android/RunAnywhereAI")  // Android app
        )

        println("Step 1: Ensuring local.properties files exist...")
        locations.forEach { dir ->
            if (dir.exists()) {
                val localProps = dir.resolve("local.properties")
                if (!localProps.exists()) {
                    println("  Creating: ${localProps.relativeTo(projectDir)}")

                    // Find Android SDK path
                    val androidHome = System.getenv("ANDROID_HOME")
                        ?: System.getenv("ANDROID_SDK_ROOT")
                        ?: "${System.getProperty("user.home")}/Android/Sdk"

                    // Find Android NDK path
                    val ndkHome = System.getenv("ANDROID_NDK_HOME")
                        ?: "$androidHome/ndk/27.0.12077973"

                    localProps.writeText("""
                        # Auto-generated by buildAll task
                        sdk.dir=$androidHome
                        ndk.dir=$ndkHome
                    """.trimIndent())
                } else {
                    println("  Exists: ${localProps.relativeTo(projectDir)}")
                }
            }
        }
        println()
    }

    doLast {
        // 1. Build SDK
        println("Step 2: Building SDK...")
        println("-".repeat(70))
        exec {
            workingDir = projectDir
            commandLine("./gradlew", ":RunAnywhereAI:sdk:runanywhere-kotlin:assembleDebug")
        }
        println()

        // 2. Build Android app
        println("Step 3: Building Android app...")
        println("-".repeat(70))
        exec {
            workingDir = file("examples/android/RunAnywhereAI")
            commandLine("./gradlew", "assembleDebug")
        }
        println()

        // 3. Publish SDK to Maven Local (for IntelliJ plugin)
        println("Step 4: Publishing SDK to Maven Local...")
        println("-".repeat(70))
        exec {
            workingDir = projectDir
            commandLine("./gradlew", ":RunAnywhereAI:sdk:runanywhere-kotlin:publishToMavenLocal")
        }
        println()

        // 4. Build IntelliJ plugin
        println("Step 5: Building IntelliJ plugin...")
        println("-".repeat(70))
        exec {
            workingDir = file("examples/intellij-plugin-demo/plugin")
            commandLine("./gradlew", "buildPlugin")
        }
        println()

        println("=".repeat(70))
        println(" Build Complete!")
        println("=".repeat(70))
        println()
        println("SDK artifacts:")
        println("  - Debug AAR: sdk/runanywhere-kotlin/build/outputs/aar/")
        println("  - Maven Local: ~/.m2/repository/com/runanywhere/runanywhere-sdk/")
        println()
        println("Example apps:")
        println("  - Android APK: examples/android/RunAnywhereAI/app/build/outputs/apk/")
        println("  - IntelliJ Plugin: examples/intellij-plugin-demo/plugin/build/distributions/")
        println()
    }
}

// ============================================================================
// SDK ONLY TASKS
// ============================================================================

tasks.register("buildSdk") {
    group = "sdk"
    description = "Build SDK only (creates local.properties if needed)"

    doFirst {
        val sdkDir = file("sdk/runanywhere-kotlin")
        val localProps = sdkDir.resolve("local.properties")

        if (!localProps.exists()) {
            println("Creating local.properties for SDK...")
            val androidHome = System.getenv("ANDROID_HOME")
                ?: System.getenv("ANDROID_SDK_ROOT")
                ?: "${System.getProperty("user.home")}/Android/Sdk"

            val ndkHome = System.getenv("ANDROID_NDK_HOME")
                ?: "$androidHome/ndk/27.0.12077973"

            localProps.writeText("""
                sdk.dir=$androidHome
                ndk.dir=$ndkHome
            """.trimIndent())
        }
    }

    doLast {
        exec {
            workingDir = projectDir
            commandLine("./gradlew", ":RunAnywhereAI:sdk:runanywhere-kotlin:assembleDebug")
        }
        println("SDK built successfully")
    }
}

tasks.register("buildSdkRelease") {
    group = "sdk"
    description = "Build SDK release variant"

    doLast {
        exec {
            workingDir = projectDir
            commandLine("./gradlew", ":RunAnywhereAI:sdk:runanywhere-kotlin:assembleRelease")
        }
        println("SDK release build completed")
    }
}

// ============================================================================
// ANDROID APP TASKS
// ============================================================================

tasks.register("buildAndroidApp") {
    group = "android"
    description = "Build Android sample app (SDK builds automatically as local module)"

    doFirst {
        val appDir = file("examples/android/RunAnywhereAI")
        val localProps = appDir.resolve("local.properties")

        if (!localProps.exists()) {
            println("Creating local.properties for Android app...")
            val androidHome = System.getenv("ANDROID_HOME")
                ?: System.getenv("ANDROID_SDK_ROOT")
                ?: "${System.getProperty("user.home")}/Android/Sdk"

            localProps.writeText("sdk.dir=$androidHome\n")
        }
    }

    doLast {
        exec {
            workingDir = file("examples/android/RunAnywhereAI")
            commandLine("./gradlew", "assembleDebug")
        }
        println("Android app built successfully")
    }
}

tasks.register("runAndroidApp") {
    group = "android"
    description = "Build and launch Android app on connected device"
    dependsOn("buildAndroidApp")

    doLast {
        // Install on connected device
        println("Installing app...")
        exec {
            workingDir = file("examples/android/RunAnywhereAI")
            commandLine("./gradlew", "installDebug")
        }

        // Launch the app
        println("Launching app...")
        exec {
            commandLine(
                "adb",
                "shell",
                "am",
                "start",
                "-n",
                "com.runanywhere.runanywhereai.debug/com.runanywhere.runanywhereai.MainActivity"
            )
        }

        println("Android app launched successfully")
    }
}

// ============================================================================
// INTELLIJ PLUGIN TASKS
// ============================================================================

tasks.register("buildIntellijPlugin") {
    group = "intellij"
    description = "Build IntelliJ plugin (publishes SDK to Maven Local first)"
    doLast {
        // 1. Publish SDK to Maven Local (plugin can't use local module)
        println("Publishing SDK to Maven Local...")
        exec {
            workingDir = projectDir
            commandLine("./gradlew", ":RunAnywhereAI:sdk:runanywhere-kotlin:publishToMavenLocal")
        }

        // 2. Build plugin
        println("Building IntelliJ plugin...")
        exec {
            workingDir = file("examples/intellij-plugin-demo/plugin")
            commandLine("./gradlew", "buildPlugin")
        }
        println("IntelliJ plugin built successfully")
    }
}

tasks.register("runIntellijPlugin") {
    group = "intellij"
    description = "Build and run IntelliJ plugin in sandbox (publishes SDK first)"
    doLast {
        // 1. Publish SDK to Maven Local (plugin can't use local module)
        println("Publishing SDK to Maven Local...")
        exec {
            workingDir = projectDir
            commandLine("./gradlew", ":RunAnywhereAI:sdk:runanywhere-kotlin:publishToMavenLocal")
        }

        // 2. Build and run plugin
        println("Building and running IntelliJ plugin...")
        exec {
            workingDir = file("examples/intellij-plugin-demo/plugin")
            commandLine("./gradlew", "runIde")
        }
        println("IntelliJ plugin launched successfully")
    }
}

// ============================================================================
// SDK PUBLISHING (for distribution only, not needed for development)
// ============================================================================

tasks.register("publishSdkToMavenLocal") {
    group = "publishing"
    description = "Publish SDK to Maven Local (for external projects, not needed for examples)"
    dependsOn(":RunAnywhereAI:sdk:runanywhere-kotlin:publishToMavenLocal")
    doLast {
        println("SDK published to Maven Local (~/.m2/repository)")
        println("  Group: com.runanywhere")
        println("  Artifact: runanywhere-sdk")
        println("  Version: 0.1.0")
        println()
        println("Note: This is automatically done for IntelliJ plugin tasks.")
        println("      Android app uses SDK as local module and doesn't need this.")
    }
}

// ============================================================================
// CLEAN TASK
// ============================================================================

tasks.register("cleanAll") {
    group = "build"
    description = "Clean SDK and all sample apps"
    doLast {
        // Clean SDK
        println("Cleaning SDK...")
        delete(layout.buildDirectory)
        file("sdk/runanywhere-kotlin/build").deleteRecursively()

        // Clean Android app
        println("Cleaning Android app...")
        exec {
            workingDir = file("examples/android/RunAnywhereAI")
            commandLine("./gradlew", "clean")
        }

        // Clean IntelliJ plugin
        println("Cleaning IntelliJ plugin...")
        exec {
            workingDir = file("examples/intellij-plugin-demo/plugin")
            commandLine("./gradlew", "clean")
        }

        println("All projects cleaned successfully")
    }
}

// ============================================================================
// UTILITY TASKS
// ============================================================================

tasks.register("setupLocalProperties") {
    group = "setup"
    description = "Create local.properties files in all necessary locations"

    doLast {
        val androidHome = System.getenv("ANDROID_HOME")
            ?: System.getenv("ANDROID_SDK_ROOT")
            ?: "${System.getProperty("user.home")}/Android/Sdk"

        val ndkHome = System.getenv("ANDROID_NDK_HOME")
            ?: "$androidHome/ndk/27.0.12077973"

        val locations = mapOf(
            "Root" to projectDir,
            "SDK" to file("sdk/runanywhere-kotlin"),
            "Android App" to file("examples/android/RunAnywhereAI")
        )

        println("Creating local.properties files...")
        println("-".repeat(70))

        locations.forEach { (name, dir) ->
            if (dir.exists()) {
                val localProps = dir.resolve("local.properties")
                val content = if (name == "SDK" || name == "Root") {
                    """
                    sdk.dir=$androidHome
                    ndk.dir=$ndkHome
                    """.trimIndent()
                } else {
                    "sdk.dir=$androidHome"
                }

                localProps.writeText(content)
                println("[$name] ${localProps.absolutePath}")
            }
        }

        println("-".repeat(70))
        println("local.properties files created successfully")
        println()
        println("Android SDK: $androidHome")
        println("Android NDK: $ndkHome")
    }
}

tasks.register("checkEnvironment") {
    group = "setup"
    description = "Check development environment setup"

    doLast {
        println("=".repeat(70))
        println(" RunAnywhere Development Environment Check")
        println("=".repeat(70))
        println()

        // Check Android SDK
        val androidHome = System.getenv("ANDROID_HOME")
            ?: System.getenv("ANDROID_SDK_ROOT")
        println("Android SDK:")
        if (androidHome != null && file(androidHome).exists()) {
            println("  [OK] $androidHome")
        } else {
            println("  [WARN] Not found or ANDROID_HOME not set")
        }
        println()

        // Check Android NDK
        val ndkHome = System.getenv("ANDROID_NDK_HOME")
        println("Android NDK:")
        if (ndkHome != null && file(ndkHome).exists()) {
            println("  [OK] $ndkHome")
        } else {
            println("  [WARN] Not found or ANDROID_NDK_HOME not set")
        }
        println()

        // Check local.properties files
        println("local.properties files:")
        val locations = mapOf(
            "Root" to projectDir,
            "SDK" to file("sdk/runanywhere-kotlin"),
            "Android App" to file("examples/android/RunAnywhereAI")
        )

        locations.forEach { (name, dir) ->
            val localProps = dir.resolve("local.properties")
            if (localProps.exists()) {
                println("  [OK] $name: ${localProps.relativeTo(projectDir)}")
            } else {
                println("  [MISSING] $name: ${localProps.relativeTo(projectDir)}")
            }
        }
        println()

        // Check gradle.properties
        val gradleProps = projectDir.resolve("gradle.properties")
        println("gradle.properties:")
        if (gradleProps.exists()) {
            println("  [OK] ${gradleProps.relativeTo(projectDir)}")
            val testLocal = gradleProps.readText().contains("runanywhere.testLocal=true")
            println("  testLocal mode: ${if (testLocal) "enabled" else "disabled"}")
        } else {
            println("  [MISSING] ${gradleProps.relativeTo(projectDir)}")
        }
        println()

        println("=".repeat(70))
        println("Run './gradlew setupLocalProperties' to create missing files")
        println("=".repeat(70))
    }
}