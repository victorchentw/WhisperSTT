name: Release All SDKs

# =============================================================================
# Unified Release Orchestration Workflow
#
# This workflow orchestrates releases of all SDK components when a unified
# version tag is pushed. It triggers individual SDK release workflows.
#
# Tag Format: v1.0.0
# This will release:
#   - RACommons (core infrastructure)
#   - Backend Libraries (LlamaCPP + ONNX)
#   - Swift SDK (iOS/macOS)
#   - Kotlin SDK (Android)
#
# NOTE: Flutter SDK and React Native SDK are NOT included in this workflow.
# They are published separately:
#   - Flutter â†’ pub.dev
#   - React Native â†’ npm
#
# Alternatively, release individual SDKs with their prefixed tags:
#   - swift-v1.0.0 â†’ Swift SDK only
#   - kotlin-v1.0.0 â†’ Kotlin SDK only
#   etc.
# =============================================================================

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+*'  # Matches v1.0.0, v1.0.0-beta, etc.
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        type: string
      release_commons:
        description: 'Release RACommons (infrastructure)'
        required: false
        default: true
        type: boolean
      release_backends:
        description: 'Release Backend Libraries'
        required: false
        default: true
        type: boolean
      release_swift:
        description: 'Release Swift SDK'
        required: false
        default: true
        type: boolean
      release_kotlin:
        description: 'Release Kotlin SDK'
        required: false
        default: true
        type: boolean
      # Flutter SDK is published to pub.dev separately - not needed in this workflow
      # release_flutter:
      #   description: 'Release Flutter SDK'
      #   required: false
      #   default: true
      #   type: boolean
      # React Native SDK is published to npm separately - not needed in this workflow
      # release_react_native:
      #   description: 'Release React Native SDK'
      #   required: false
      #   default: true
      #   type: boolean
      # publish_npm:
      #   description: 'Publish React Native SDK to npm'
      #   required: false
      #   default: false
      #   type: boolean
      dry_run:
        description: 'Dry run (build only, no publish)'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  packages: write

jobs:
  # ===========================================================================
  # Determine Version
  # ===========================================================================
  setup:
    name: Setup Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      release_commons: ${{ steps.flags.outputs.release_commons }}
      release_backends: ${{ steps.flags.outputs.release_backends }}
      release_swift: ${{ steps.flags.outputs.release_swift }}
      release_kotlin: ${{ steps.flags.outputs.release_kotlin }}
      # Flutter/React Native use pub.dev/npm - outputs not needed
      # release_flutter: ${{ steps.flags.outputs.release_flutter }}
      # release_react_native: ${{ steps.flags.outputs.release_react_native }}
      # publish_npm: ${{ steps.flags.outputs.publish_npm }}
      dry_run: ${{ steps.flags.outputs.dry_run }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine Version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Preparing release v$VERSION"

      - name: Set Release Flags
        id: flags
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "release_commons=${{ github.event.inputs.release_commons }}" >> $GITHUB_OUTPUT
            echo "release_backends=${{ github.event.inputs.release_backends }}" >> $GITHUB_OUTPUT
            echo "release_swift=${{ github.event.inputs.release_swift }}" >> $GITHUB_OUTPUT
            echo "release_kotlin=${{ github.event.inputs.release_kotlin }}" >> $GITHUB_OUTPUT
            # Flutter/React Native use pub.dev/npm separately
            # echo "release_flutter=${{ github.event.inputs.release_flutter }}" >> $GITHUB_OUTPUT
            # echo "release_react_native=${{ github.event.inputs.release_react_native }}" >> $GITHUB_OUTPUT
            # echo "publish_npm=${{ github.event.inputs.publish_npm }}" >> $GITHUB_OUTPUT
            echo "dry_run=${{ github.event.inputs.dry_run }}" >> $GITHUB_OUTPUT
          else
            # Tag push releases everything
            echo "release_commons=true" >> $GITHUB_OUTPUT
            echo "release_backends=true" >> $GITHUB_OUTPUT
            echo "release_swift=true" >> $GITHUB_OUTPUT
            echo "release_kotlin=true" >> $GITHUB_OUTPUT
            # Flutter/React Native use pub.dev/npm separately
            # echo "release_flutter=true" >> $GITHUB_OUTPUT
            # echo "release_react_native=true" >> $GITHUB_OUTPUT
            # echo "publish_npm=false" >> $GITHUB_OUTPUT
            echo "dry_run=false" >> $GITHUB_OUTPUT
          fi

  # ===========================================================================
  # Release RACommons (Foundation)
  # ===========================================================================
  release-commons:
    name: Release RACommons
    needs: setup
    if: needs.setup.outputs.release_commons == 'true'
    uses: ./.github/workflows/commons-release.yml
    with:
      version: ${{ needs.setup.outputs.version }}
      dry_run: ${{ needs.setup.outputs.dry_run == 'true' }}
      skip_publish: true  # Skip individual release, use unified release
    secrets: inherit

  # ===========================================================================
  # Release Backend Libraries (depends on Commons)
  # ===========================================================================
  release-backends:
    name: Release Backends
    needs: [setup, release-commons]
    if: |
      always() &&
      needs.setup.outputs.release_backends == 'true' &&
      (needs.release-commons.result == 'success' || needs.release-commons.result == 'skipped')
    uses: ./.github/workflows/backends-release.yml
    with:
      version: ${{ needs.setup.outputs.version }}
      backends: all
      dry_run: ${{ needs.setup.outputs.dry_run == 'true' }}
      skip_publish: true  # Skip individual release, use unified release
    secrets: inherit

  # ===========================================================================
  # Release Swift SDK (depends on Backends)
  # ===========================================================================
  release-swift:
    name: Release Swift SDK
    needs: [setup, release-backends]
    if: |
      always() &&
      needs.setup.outputs.release_swift == 'true' &&
      (needs.release-backends.result == 'success' || needs.release-backends.result == 'skipped')
    uses: ./.github/workflows/swift-sdk-release.yml
    with:
      version: ${{ needs.setup.outputs.version }}
      update_binaries: true
      dry_run: ${{ needs.setup.outputs.dry_run == 'true' }}
      skip_publish: true  # Skip individual release, use unified release
    secrets: inherit

  # ===========================================================================
  # Release Kotlin SDK (depends on Backends)
  # ===========================================================================
  release-kotlin:
    name: Release Kotlin SDK
    needs: [setup, release-backends]
    if: |
      always() &&
      needs.setup.outputs.release_kotlin == 'true' &&
      (needs.release-backends.result == 'success' || needs.release-backends.result == 'skipped')
    uses: ./.github/workflows/kotlin-sdk-release.yml
    with:
      version: ${{ needs.setup.outputs.version }}
      publish_maven: false
      dry_run: ${{ needs.setup.outputs.dry_run == 'true' }}
      skip_publish: true  # Skip individual release, use unified release
    secrets: inherit

  # ===========================================================================
  # Release Flutter SDK - DISABLED (published to pub.dev separately)
  # ===========================================================================
  # release-flutter:
  #   name: Release Flutter SDK
  #   needs: [setup, release-backends]
  #   if: |
  #     always() &&
  #     needs.setup.outputs.release_flutter == 'true' &&
  #     (needs.release-backends.result == 'success' || needs.release-backends.result == 'skipped')
  #   uses: ./.github/workflows/flutter-sdk-release.yml
  #   with:
  #     version: ${{ needs.setup.outputs.version }}
  #     publish_pubdev: false
  #     dry_run: ${{ needs.setup.outputs.dry_run == 'true' }}
  #     skip_publish: true  # Skip individual release, use unified release
  #   secrets: inherit

  # ===========================================================================
  # Release React Native SDK - DISABLED (published to npm separately)
  # ===========================================================================
  # release-react-native:
  #   name: Release React Native SDK
  #   needs: [setup, release-backends]
  #   if: |
  #     always() &&
  #     needs.setup.outputs.release_react_native == 'true' &&
  #     (needs.release-backends.result == 'success' || needs.release-backends.result == 'skipped')
  #   uses: ./.github/workflows/react-native-sdk-release.yml
  #   with:
  #     version: ${{ needs.setup.outputs.version }}
  #     publish_npm: ${{ needs.setup.outputs.publish_npm == 'true' }}
  #     dry_run: ${{ needs.setup.outputs.dry_run == 'true' }}
  #     skip_publish: true  # Skip individual release, use unified release
  #   secrets: inherit

  # ===========================================================================
  # Create Unified Release (Single release with all assets)
  # ===========================================================================
  create-unified-release:
    name: Create Unified Release
    needs: [setup, release-commons, release-backends, release-swift, release-kotlin]
    # NOTE: Flutter/React Native removed - they use pub.dev/npm separately
    if: |
      always() &&
      needs.setup.outputs.dry_run != 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout for Package.swift Update
        uses: actions/checkout@v4

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts

      - name: Debug - List Downloaded Artifacts
        run: |
          echo "=== All artifacts directory structure ==="
          ls -la all-artifacts/ || echo "all-artifacts/ does not exist"
          echo ""
          echo "=== Full tree (first 100 entries) ==="
          find all-artifacts -type d | head -100
          echo ""
          echo "=== Files (first 50) ==="
          find all-artifacts -type f | head -50

      - name: Prepare Release Assets
        run: |
          VERSION="${{ needs.setup.outputs.version }}"
          mkdir -p release-assets

          echo "=== Looking for artifacts with VERSION=$VERSION ==="
          echo ""

          # List what we're looking for vs what exists
          echo "Expected: all-artifacts/racommons-ios-$VERSION"
          ls -la "all-artifacts/racommons-ios-$VERSION" 2>&1 || echo "NOT FOUND"
          echo ""
          echo "Expected: all-artifacts/backend-llamacpp-ios-$VERSION"
          ls -la "all-artifacts/backend-llamacpp-ios-$VERSION" 2>&1 || echo "NOT FOUND"
          echo ""
          echo "Expected: all-artifacts/backend-onnx-ios-$VERSION"
          ls -la "all-artifacts/backend-onnx-ios-$VERSION" 2>&1 || echo "NOT FOUND"
          echo ""

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # RACommons
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # iOS - Find XCFramework and zip it at root level for SPM compatibility
          if [ -d "all-artifacts/racommons-ios-$VERSION" ]; then
            echo "âœ… Found racommons-ios-$VERSION, creating zip..."
            COMMONS_DIR="all-artifacts/racommons-ios-$VERSION"

            # Find the RACommons.xcframework (may be nested in dist/ or elsewhere)
            XCFW_PATH=$(find "$COMMONS_DIR" -name "RACommons.xcframework" -type d | head -1)

            if [ -n "$XCFW_PATH" ] && [ -d "$XCFW_PATH" ]; then
              echo "Found XCFramework at: $XCFW_PATH"
              mkdir -p commons-package
              cp -R "$XCFW_PATH" commons-package/
              cd commons-package
              zip -r "../release-assets/RACommons-ios-v${VERSION}.zip" RACommons.xcframework
              cd ..
              rm -rf commons-package
              echo "Created: RACommons-ios-v${VERSION}.zip (XCFramework at root)"
            else
              echo "âš ï¸  XCFramework not found in artifact, zipping entire directory"
              cd "$COMMONS_DIR"
              zip -r "../../release-assets/RACommons-ios-v${VERSION}.zip" .
              cd ../..
            fi
          else
            echo "âŒ racommons-ios-$VERSION NOT FOUND"
          fi

          # Android - SPLIT by ABI for smaller downloads
          for abi in arm64-v8a armeabi-v7a x86_64; do
            if [ -d "all-artifacts/racommons-android-${abi}-${VERSION}" ]; then
              cd "all-artifacts/racommons-android-${abi}-${VERSION}"
              zip -r "../../release-assets/RACommons-android-${abi}-v${VERSION}.zip" .
              cd ../..
            fi
          done

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Backend Libraries - ALL SPLIT by ABI
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # LlamaCPP iOS - Find XCFramework and zip it at root level for SPM compatibility
          if [ -d "all-artifacts/backend-llamacpp-ios-$VERSION" ]; then
            echo "âœ… Found backend-llamacpp-ios-$VERSION, creating zip..."
            LLAMA_DIR="all-artifacts/backend-llamacpp-ios-$VERSION"

            # Find the RABackendLLAMACPP.xcframework (may be nested in dist/ or elsewhere)
            XCFW_PATH=$(find "$LLAMA_DIR" -name "RABackendLLAMACPP.xcframework" -type d | head -1)

            if [ -n "$XCFW_PATH" ] && [ -d "$XCFW_PATH" ]; then
              echo "Found XCFramework at: $XCFW_PATH"
              mkdir -p llama-package
              cp -R "$XCFW_PATH" llama-package/
              cd llama-package
              zip -r "../release-assets/RABackendLLAMACPP-ios-v${VERSION}.zip" RABackendLLAMACPP.xcframework
              cd ..
              rm -rf llama-package
              echo "Created: RABackendLLAMACPP-ios-v${VERSION}.zip (XCFramework at root)"
            else
              echo "âš ï¸  XCFramework not found in artifact, zipping entire directory"
              cd "$LLAMA_DIR"
              zip -r "../../release-assets/RABackendLLAMACPP-ios-v${VERSION}.zip" .
              cd ../..
            fi
          else
            echo "âŒ backend-llamacpp-ios-$VERSION NOT FOUND"
          fi

          # ONNX iOS - Find XCFramework and zip it at root level for SPM compatibility
          if [ -d "all-artifacts/backend-onnx-ios-$VERSION" ]; then
            echo "âœ… Found backend-onnx-ios-$VERSION, creating zip..."
            ONNX_DIR="all-artifacts/backend-onnx-ios-$VERSION"

            # Find the RABackendONNX.xcframework (may be nested in dist/ or elsewhere)
            XCFW_PATH=$(find "$ONNX_DIR" -name "RABackendONNX.xcframework" -type d | head -1)

            if [ -n "$XCFW_PATH" ] && [ -d "$XCFW_PATH" ]; then
              echo "Found XCFramework at: $XCFW_PATH"
              # Create temp directory with correct structure
              mkdir -p onnx-package
              cp -R "$XCFW_PATH" onnx-package/
              cd onnx-package
              zip -r "../release-assets/RABackendONNX-ios-v${VERSION}.zip" RABackendONNX.xcframework
              cd ..
              rm -rf onnx-package
              echo "Created: RABackendONNX-ios-v${VERSION}.zip (XCFramework at root)"
            else
              echo "âš ï¸  XCFramework not found in artifact, zipping entire directory"
              cd "$ONNX_DIR"
              zip -r "../../release-assets/RABackendONNX-ios-v${VERSION}.zip" .
              cd ../..
            fi
          else
            echo "âŒ backend-onnx-ios-$VERSION NOT FOUND"
          fi

          # LlamaCPP Android - SPLIT by ABI
          for abi in arm64-v8a armeabi-v7a x86_64; do
            if [ -d "all-artifacts/backends-android-${abi}-${VERSION}" ]; then
              if [ -d "all-artifacts/backends-android-${abi}-${VERSION}/llamacpp/${abi}" ]; then
                mkdir -p "android-llamacpp-${abi}/jniLibs/${abi}"
                cp -r "all-artifacts/backends-android-${abi}-${VERSION}/llamacpp/${abi}"/*.so "android-llamacpp-${abi}/jniLibs/${abi}/" 2>/dev/null || true
                if [ "$(find android-llamacpp-${abi} -name '*.so' 2>/dev/null | head -1)" ]; then
                  cd "android-llamacpp-${abi}" && zip -r "../release-assets/RABackendLLAMACPP-android-${abi}-v${VERSION}.zip" . && cd ..
                fi
                rm -rf "android-llamacpp-${abi}"
              fi
            fi
          done

          # ONNX Android - SPLIT by ABI
          for abi in arm64-v8a armeabi-v7a x86_64; do
            if [ -d "all-artifacts/backends-android-${abi}-${VERSION}" ]; then
              if [ -d "all-artifacts/backends-android-${abi}-${VERSION}/onnx/${abi}" ]; then
                mkdir -p "android-onnx-${abi}/jniLibs/${abi}"
                cp -r "all-artifacts/backends-android-${abi}-${VERSION}/onnx/${abi}"/*.so "android-onnx-${abi}/jniLibs/${abi}/" 2>/dev/null || true
                if [ "$(find android-onnx-${abi} -name '*.so' 2>/dev/null | head -1)" ]; then
                  cd "android-onnx-${abi}" && zip -r "../release-assets/RABackendONNX-android-${abi}-v${VERSION}.zip" . && cd ..
                fi
                rm -rf "android-onnx-${abi}"
              fi
            fi
          done

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Swift SDK
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          if [ -d "all-artifacts/swift-sdk-build-$VERSION" ]; then
            cd "all-artifacts/swift-sdk-build-$VERSION"
            zip -r "../../release-assets/RunAnywhere-Swift-SDK-v${VERSION}.zip" .
            cd ../..
          fi

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Kotlin SDK
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          if [ -d "all-artifacts/kotlin-sdk-aar-$VERSION" ]; then
            cp "all-artifacts/kotlin-sdk-aar-$VERSION"/*.aar "release-assets/RunAnywhere-Kotlin-SDK-v${VERSION}.aar" 2>/dev/null || true
          fi

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Flutter SDK - DISABLED (published to pub.dev separately)
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # if [ -d "all-artifacts/flutter-sdk-package-$VERSION" ]; then
          #   cp "all-artifacts/flutter-sdk-package-$VERSION"/*.zip "release-assets/RunAnywhere-Flutter-SDK-v${VERSION}.zip" 2>/dev/null || true
          # fi

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # React Native SDK - DISABLED (published to npm separately)
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # if [ -d "all-artifacts/react-native-sdk-package-$VERSION" ]; then
          #   cp "all-artifacts/react-native-sdk-package-$VERSION"/*.zip "release-assets/RunAnywhere-ReactNative-SDK-v${VERSION}.zip" 2>/dev/null || true
          # fi

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Generate Checksums
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          echo ""
          echo "=========================================="
          echo "=== FINAL: Release Assets Created ==="
          echo "=========================================="
          cd release-assets
          ls -la

          # Count files
          ZIP_COUNT=$(ls -1 *.zip 2>/dev/null | wc -l || echo "0")
          AAR_COUNT=$(ls -1 *.aar 2>/dev/null | wc -l || echo "0")
          echo ""
          echo "Total ZIP files: $ZIP_COUNT"
          echo "Total AAR files: $AAR_COUNT"

          if [ "$ZIP_COUNT" -eq "0" ] && [ "$AAR_COUNT" -eq "0" ]; then
            echo ""
            echo "âš ï¸  WARNING: No release assets were created!"
            echo "This likely means the artifact directories were not found."
            echo "Check the debug output above for missing directories."
          fi

          echo "" > checksums.sha256
          for f in *.zip *.aar; do
            if [ -f "$f" ]; then
              shasum -a 256 "$f" >> checksums.sha256
            fi
          done
          echo ""
          echo "=== Checksums ==="
          cat checksums.sha256

      - name: Update Root Package.swift Checksums
        run: |
          VERSION="${{ needs.setup.outputs.version }}"
          ROOT_PACKAGE="Package.swift"

          if [ ! -f "$ROOT_PACKAGE" ]; then
            echo "Root Package.swift not found, skipping checksum update"
            exit 0
          fi

          echo "=== Updating Package.swift for v$VERSION ==="

          # Update the SDK version
          sed -i 's/let sdkVersion = "[^"]*"/let sdkVersion = "'"$VERSION"'"/' "$ROOT_PACKAGE"
          echo "Updated sdkVersion to: $VERSION"

          # Compute and update checksums from release assets
          cd release-assets

          # RACommons checksum
          if [ -f "RACommons-ios-v${VERSION}.zip" ]; then
            COMMONS_CHECKSUM=$(shasum -a 256 "RACommons-ios-v${VERSION}.zip" | cut -d ' ' -f 1)
            echo "RACommons checksum: $COMMONS_CHECKSUM"
            cd ..
            sed -i 's/checksum: "CHECKSUM_RACOMMONS"/checksum: "'"$COMMONS_CHECKSUM"'"/' "$ROOT_PACKAGE"
            cd release-assets
          else
            echo "âš ï¸  RACommons-ios-v${VERSION}.zip not found, checksum not updated"
          fi

          # RABackendLlamaCPP checksum
          if [ -f "RABackendLLAMACPP-ios-v${VERSION}.zip" ]; then
            LLAMACPP_CHECKSUM=$(shasum -a 256 "RABackendLLAMACPP-ios-v${VERSION}.zip" | cut -d ' ' -f 1)
            echo "RABackendLlamaCPP checksum: $LLAMACPP_CHECKSUM"
            cd ..
            sed -i 's/checksum: "CHECKSUM_LLAMACPP"/checksum: "'"$LLAMACPP_CHECKSUM"'"/' "$ROOT_PACKAGE"
            cd release-assets
          else
            echo "âš ï¸  RABackendLLAMACPP-ios-v${VERSION}.zip not found, checksum not updated"
          fi

          # RABackendONNX checksum
          if [ -f "RABackendONNX-ios-v${VERSION}.zip" ]; then
            ONNX_CHECKSUM=$(shasum -a 256 "RABackendONNX-ios-v${VERSION}.zip" | cut -d ' ' -f 1)
            echo "RABackendONNX checksum: $ONNX_CHECKSUM"
            cd ..
            sed -i 's/checksum: "CHECKSUM_ONNX"/checksum: "'"$ONNX_CHECKSUM"'"/' "$ROOT_PACKAGE"
            cd release-assets
          else
            echo "âš ï¸  RABackendONNX-ios-v${VERSION}.zip not found, checksum not updated"
          fi

          cd ..

          echo ""
          echo "=== Updated Package.swift binaryTargets ==="
          grep -A2 "binaryTarget" "$ROOT_PACKAGE" | head -30 || true

      - name: Commit Package.swift and Update Tag
        run: |
          VERSION="${{ needs.setup.outputs.version }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add Package.swift || true

          if git diff --staged --quiet; then
            echo "No Package.swift changes to commit"
          else
            git commit -m "chore: update Package.swift checksums for v$VERSION"

            # Push to main/master
            git push origin HEAD:main || git push origin HEAD:master || echo "Push to default branch skipped"

            echo "=== Updating tag v$VERSION to include Package.swift changes ==="

            # Delete the remote tag
            git push origin :refs/tags/v$VERSION || echo "Remote tag deletion skipped (may not exist)"

            # Delete local tag
            git tag -d v$VERSION || echo "Local tag deletion skipped"

            # Create new tag pointing to current commit (with updated Package.swift)
            git tag -a v$VERSION -m "Release v$VERSION"

            # Push the new tag
            git push origin v$VERSION

            echo "âœ… Tag v$VERSION updated to point to commit with correct checksums"
          fi

      - name: Create Unified GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.setup.outputs.version }}
          name: RunAnywhere SDKs v${{ needs.setup.outputs.version }}
          files: release-assets/*
          body: |
            ## RunAnywhere SDKs v${{ needs.setup.outputs.version }}

            **Privacy-first, on-device AI SDKs** for iOS, Android, Flutter, and React Native.

            ---

            ### ğŸ“¦ Release Assets

            #### Core Libraries
            | Asset | Platform | Size |
            |-------|----------|------|
            | `RACommons-ios-v${{ needs.setup.outputs.version }}.zip` | iOS/macOS | ~2 MB |
            | `RACommons-android-arm64-v8a-v${{ needs.setup.outputs.version }}.zip` | Android arm64 | ~61 MB |
            | `RACommons-android-armeabi-v7a-v${{ needs.setup.outputs.version }}.zip` | Android armv7 | ~57 MB |
            | `RACommons-android-x86_64-v${{ needs.setup.outputs.version }}.zip` | Android x86_64 | ~64 MB |

            #### Backend Libraries (pick what you need)
            | Asset | Platform | Use Case |
            |-------|----------|----------|
            | `RABackendLLAMACPP-ios-v${{ needs.setup.outputs.version }}.zip` | iOS/macOS | LLM |
            | `RABackendLLAMACPP-android-arm64-v8a-v${{ needs.setup.outputs.version }}.zip` | Android arm64 | LLM |
            | `RABackendLLAMACPP-android-armeabi-v7a-v${{ needs.setup.outputs.version }}.zip` | Android armv7 | LLM |
            | `RABackendLLAMACPP-android-x86_64-v${{ needs.setup.outputs.version }}.zip` | Android x86_64 | LLM |
            | `RABackendONNX-ios-v${{ needs.setup.outputs.version }}.zip` | iOS/macOS | STT/TTS/VAD |
            | `RABackendONNX-android-arm64-v8a-v${{ needs.setup.outputs.version }}.zip` | Android arm64 | STT/TTS/VAD |
            | `RABackendONNX-android-armeabi-v7a-v${{ needs.setup.outputs.version }}.zip` | Android armv7 | STT/TTS/VAD |
            | `RABackendONNX-android-x86_64-v${{ needs.setup.outputs.version }}.zip` | Android x86_64 | STT/TTS/VAD |

            #### SDK Packages
            | Asset | Platform | Description |
            |-------|----------|-------------|
            | `RunAnywhere-Swift-SDK-v${{ needs.setup.outputs.version }}.zip` | iOS/macOS | Swift SDK |
            | `RunAnywhere-Kotlin-SDK-v${{ needs.setup.outputs.version }}.aar` | Android | Kotlin SDK (AAR) |

            > **Note:** Flutter SDK is available on [pub.dev](https://pub.dev/packages/runanywhere), React Native SDK is available on [npm](https://www.npmjs.com/package/@runanywhere/core)

            > ğŸ’¡ **Tip:** Most Android apps only need `arm64-v8a` (85% of devices)

            ---

            ### ğŸš€ Quick Start

            <details>
            <summary><b>Swift (iOS/macOS)</b></summary>

            ```swift
            // Package.swift
            dependencies: [
                .package(url: "https://github.com/RunanywhereAI/runanywhere-sdks", from: "${{ needs.setup.outputs.version }}")
            ]
            ```

            Or download the XCFrameworks directly from this release.
            </details>

            <details>
            <summary><b>Kotlin (Android)</b></summary>

            ```kotlin
            // build.gradle.kts
            dependencies {
                implementation("ai.runanywhere:runanywhere-kotlin:${{ needs.setup.outputs.version }}")
            }
            ```

            Or download `RunAnywhere-Kotlin-SDK-v${{ needs.setup.outputs.version }}.aar` from this release.
            </details>

            <details>
            <summary><b>Flutter</b></summary>

            ```yaml
            # pubspec.yaml - Install from pub.dev
            dependencies:
              runanywhere: ^${{ needs.setup.outputs.version }}
            ```

            Or visit [pub.dev/packages/runanywhere](https://pub.dev/packages/runanywhere)
            </details>

            <details>
            <summary><b>React Native</b></summary>

            ```bash
            # Install from npm
            npm install @runanywhere/core
            ```

            Or visit [npmjs.com/package/@runanywhere/core](https://www.npmjs.com/package/@runanywhere/core)
            </details>

            ---

            ### âœ¨ Features

            - ğŸ§  **LLM**: On-device text generation via llama.cpp
            - ğŸ¤ **STT**: Speech-to-text via Sherpa-ONNX Whisper
            - ğŸ”Š **TTS**: Text-to-speech via Sherpa-ONNX Piper
            - ğŸ¯ **VAD**: Voice activity detection
            - ğŸ”’ **Privacy**: All processing happens on-device

            ---

            ### ğŸ“‹ Build Status

            | Component | Status |
            |-----------|--------|
            | RACommons | ${{ needs.release-commons.result == 'success' && 'âœ…' || 'âŒ' }} |
            | Backends | ${{ needs.release-backends.result == 'success' && 'âœ…' || 'âŒ' }} |
            | Swift SDK | ${{ needs.release-swift.result == 'success' && 'âœ…' || 'âŒ' }} |
            | Kotlin SDK | ${{ needs.release-kotlin.result == 'success' && 'âœ…' || 'âŒ' }} |

            ---

            ### ğŸ” Verification

            ```bash
            shasum -a 256 -c checksums.sha256
            ```

            ---

            Built from commit: ${{ github.sha }}
          draft: false
          prerelease: ${{ contains(needs.setup.outputs.version, 'test') || contains(needs.setup.outputs.version, 'beta') || contains(needs.setup.outputs.version, 'alpha') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
