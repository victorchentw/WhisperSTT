name: Binary Size Check

on:
  pull_request:
    branches: [main]
    paths:
      - 'include/**'
      - 'src/**'
      - 'CMakeLists.txt'
  workflow_dispatch:

env:
  # RACommons size limit: 3MB
  LIMIT_RACOMMONS: 3145728

jobs:
  size-check:
    name: Check Binary Sizes
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.4'

      - name: Build iOS XCFramework
        run: |
          chmod +x scripts/build-rac-commons.sh
          ./scripts/build-rac-commons.sh --ios --release

      - name: Analyze Sizes
        id: sizes
        run: |
          echo "=== RACommons.xcframework ===" > size-report.txt

          if [ -d "dist/RACommons.xcframework" ]; then
            XCFW_SIZE=$(du -sb dist/RACommons.xcframework | cut -f1)
            echo "Total: $(du -sh dist/RACommons.xcframework | cut -f1)" >> size-report.txt
            echo "" >> size-report.txt

            # Show breakdown
            for slice in dist/RACommons.xcframework/*/; do
              if [ -d "$slice" ]; then
                SLICE_NAME=$(basename "$slice")
                SLICE_SIZE=$(du -sh "$slice" | cut -f1)
                echo "$SLICE_NAME: $SLICE_SIZE" >> size-report.txt
              fi
            done

            echo "xcfw_size=$XCFW_SIZE" >> $GITHUB_OUTPUT
          else
            echo "XCFramework not found" >> size-report.txt
            echo "xcfw_size=0" >> $GITHUB_OUTPUT
          fi

          cat size-report.txt

      - name: Check Size Limit
        run: |
          SIZE=${{ steps.sizes.outputs.xcfw_size }}
          LIMIT=${{ env.LIMIT_RACOMMONS }}

          if [ "$SIZE" -eq 0 ]; then
            echo "⚠️ No build output to check"
            exit 0
          fi

          if [ "$SIZE" -gt "$LIMIT" ]; then
            SIZE_MB=$(echo "scale=2; $SIZE / 1048576" | bc)
            LIMIT_MB=$(echo "scale=2; $LIMIT / 1048576" | bc)
            echo "❌ RACommons.xcframework (${SIZE_MB}MB) exceeds limit (${LIMIT_MB}MB)"
            exit 1
          fi

          SIZE_MB=$(echo "scale=2; $SIZE / 1048576" | bc)
          LIMIT_MB=$(echo "scale=2; $LIMIT / 1048576" | bc)
          echo "✅ RACommons.xcframework: ${SIZE_MB}MB (limit: ${LIMIT_MB}MB)"

      - name: Upload Size Report
        uses: actions/upload-artifact@v4
        with:
          name: size-report
          path: size-report.txt
