// RunAnywhere LlamaCPP Backend - Android
//
// This plugin bundles RABackendLlamaCPP native libraries (.so files) for Android.
// RABackendLlamaCPP provides LLM text generation capabilities using llama.cpp.
//
// Binary Configuration:
//   Edit binary_config.gradle to toggle between local and remote binaries:
//   - testLocal = true:  Use local .so files from android/src/main/jniLibs/ (for development)
//   - testLocal = false: Download from GitHub releases (for production)
//
// Version: Must match Swift SDK's Package.swift and Kotlin SDK's build.gradle.kts

group 'ai.runanywhere.sdk.llamacpp'
version '0.15.8'

// Load binary configuration
apply from: 'binary_config.gradle'

buildscript {
    ext.kotlin_version = '1.9.10'
    repositories {
        google()
        mavenCentral()
    }
    dependencies {
        classpath 'com.android.tools.build:gradle:8.1.0'
        classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version"
    }
}

apply plugin: 'com.android.library'
apply plugin: 'kotlin-android'

android {
    namespace 'ai.runanywhere.sdk.llamacpp'
    compileSdk 34

    // Use NDK for native library support
    ndkVersion "25.2.9519653"

    defaultConfig {
        minSdk 24
        targetSdk 34

        // ABI filters for native libraries
        ndk {
            abiFilters 'arm64-v8a', 'armeabi-v7a', 'x86_64'
        }

        // Consumer proguard rules
        consumerProguardFiles 'proguard-rules.pro'
    }

    compileOptions {
        sourceCompatibility JavaVersion.VERSION_1_8
        targetCompatibility JavaVersion.VERSION_1_8
    }

    kotlinOptions {
        jvmTarget = '1.8'
    }

    sourceSets {
        main {
            // Native libraries location - use downloaded libs or local libs based on config
            jniLibs.srcDirs = [testLocal ? 'src/main/jniLibs' : 'build/jniLibs']
        }
    }

    buildTypes {
        release {
            minifyEnabled false
        }
    }
}

dependencies {
    implementation "org.jetbrains.kotlin:kotlin-stdlib-jdk8:$kotlin_version"
}

// =============================================================================
// Binary Download Task (runs when testLocal = false)
// =============================================================================
task downloadNativeLibs {
    group = 'runanywhere'
    description = 'Download RABackendLlamaCPP native libraries from GitHub releases'

    doLast {
        if (shouldDownloadAndroidLibs()) {
            println "üì¶ Remote mode: Downloading RABackendLlamaCPP Android native libraries..."

            def jniLibsDir = file('build/jniLibs')
            if (jniLibsDir.exists()) {
                delete(jniLibsDir)
            }
            jniLibsDir.mkdirs()

            // Ensure build directory exists
            buildDir.mkdirs()

            def downloadUrl = llamacppAndroidUrl
            def zipFile = file("${buildDir}/llamacpp-android.zip")

            println "Downloading from: ${downloadUrl}"

            // Download the zip file
            ant.get(src: downloadUrl, dest: zipFile)

            println "‚úÖ Downloaded successfully"

            // Extract to temp directory first
            def tempDir = file("${buildDir}/llamacpp-temp")
            if (tempDir.exists()) {
                delete(tempDir)
            }
            tempDir.mkdirs()

            copy {
                from zipTree(zipFile)
                into tempDir
            }

            // Common libs that should NOT be duplicated (they're in the core SDK)
            def commonLibs = ['libc++_shared.so', 'librac_commons.so', 'librac_commons_jni.so']

            // Copy .so files from jniLibs structure (excluding common libs)
            tempDir.eachFileRecurse { file ->
                if (file.isDirectory() && file.name in ['arm64-v8a', 'armeabi-v7a', 'x86_64', 'x86']) {
                    def targetAbiDir = new File(jniLibsDir, file.name)
                    targetAbiDir.mkdirs()
                    file.eachFile { soFile ->
                        if (soFile.name.endsWith('.so') && !(soFile.name in commonLibs)) {
                            copy {
                                from soFile
                                into targetAbiDir
                            }
                            println "  ‚úì ${file.name}/${soFile.name}"
                        }
                    }
                }
            }

            // Clean up
            zipFile.delete()
            if (tempDir.exists()) {
                delete(tempDir)
            }

            println "‚úÖ RABackendLlamaCPP native libraries downloaded successfully"
        } else {
            println "üîß Local mode: Using native libraries from src/main/jniLibs/"

            if (!checkLocalLibsExist()) {
                throw new GradleException("""
                    ‚ö†Ô∏è  Native libraries not found in src/main/jniLibs/!
                    For local mode, please build and copy the libraries:
                      1. cd runanywhere-core && ./scripts/build-android.sh --llamacpp
                      2. Copy the .so files to packages/runanywhere_llamacpp/android/src/main/jniLibs/
                    Or switch to remote mode by editing binary_config.gradle:
                      testLocal = false
                """)
            } else {
                println "‚úÖ Using local native libraries"
            }
        }
    }
}

// Run downloadNativeLibs before preBuild
preBuild.dependsOn downloadNativeLibs
